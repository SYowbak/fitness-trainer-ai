# Розрахунок токенів для плану тренувань

## Ліміти Gemini 2.5 Flash
- **Input:** 1,048,576 токенів (1M)
- **Output:** **65,536 токенів** (~49,000 слів)

---

## Розрахунок для плану тренувань

### Структура плану:

**1 день тренування містить:**
- Розминка: ~100 слів = ~130 токенів
- 6-8 вправ × ~200 слів кожна = ~1,200 слів = ~1,600 токенів
- Заминка: ~100 слів = ~130 токенів
- Notes: ~100 слів = ~130 токенів
- **РАЗОМ на 1 день: ~1,500 слів = ~2,000 токенів**

### Для різної частоти тренувань:

| Частота | Днів | Слів | Токенів | % від ліміту |
|---------|------|------|---------|--------------|
| 3 дні/тиждень | 3 | 4,500 | 6,000 | 9% |
| 4 дні/тиждень | 4 | 6,000 | 8,000 | 12% |
| 5 днів/тиждень | 5 | 7,500 | 10,000 | 15% |
| 6 днів/тиждень | 6 | 9,000 | 12,000 | 18% |

### З додатковими полями (targetWeight + recommendation):

**1 вправа з новими полями:**
- Базовий опис: ~200 слів = ~270 токенів
- targetWeight: 1 число = ~1 токен
- recommendation.text: ~50 слів = ~65 токенів
- **РАЗОМ на 1 вправу: ~250 слів = ~336 токенів**

**1 день з новими полями:**
- 6-8 вправ × 336 токенів = ~2,400 токенів
- Розминка + заминка + notes = ~400 токенів
- **РАЗОМ на 1 день: ~2,800 токенів**

### Оновлена таблиця з recommendation:

| Частота | Днів | Токенів | % від ліміту | Безпечно? |
|---------|------|---------|--------------|-----------|
| 3 дні/тиждень | 3 | 8,400 | 13% | Так |
| 4 дні/тиждень | 4 | 11,200 | 17% | Так |
| 5 днів/тиждень | 5 | 14,000 | 21% | Так |
| 6 днів/тиждень | 6 | 16,800 | 26% | Так |

---

## Потенційні проблеми

### 1. Дуже детальні описи

Якщо AI генерує **ДУЖЕ детальні** описи:
- 1 вправа: ~400 слів = ~530 токенів
- 1 день: ~4,500 токенів
- 6 днів: **27,000 токенів** (41% ліміту)

**Ризик:** Середній - все ще в межах ліміту

### 2. Проблеми здоров'я

Якщо користувач має **багато проблем здоров'я**:
- Промпт стає довшим (+500-1000 токенів input)
- AI генерує більше пояснень про безпеку (+200 токенів на вправу)
- 1 день: ~3,500 токенів
- 6 днів: **21,000 токенів** (32% ліміту)

**Ризик:** Низький - в межах ліміту

### 3. Комбінація всього

**Найгірший сценарій:**
- 6 днів тренувань
- Дуже детальні описи
- Багато проблем здоров'я
- targetWeight + recommendation
- **Разом: ~30,000 токенів** (46% ліміту)

**Ризик:** Низький - все ще в межах ліміту

---

## Захист від обрізання відповіді

### Поточний стан:

```typescript
// geminiService.ts:257
const model = ai!.getGenerativeModel({ model: selectedModel });
// Немає maxOutputTokens!
```

**Проблема:** Якщо не вказати `maxOutputTokens`, модель може використати дефолтне значення (часто 2048-8192 токенів).

### Рішення

```typescript
const model = ai!.getGenerativeModel({ 
  model: selectedModel,
  generationConfig: {
    maxOutputTokens: 32000, // 50% від ліміту - достатньо для будь-якого плану
    temperature: 0.7, // Креативність для різноманітних рекомендацій
    topK: 40,
    topP: 0.95
  }
});
```

### Чому 32 000 токенів

1. **Достатньо для будь-якого плану:**
   - Найгірший сценарій: ~30,000 токенів
   - Запас: 2,000 токенів

2. **Не надто багато:**
   - Не витрачаємо зайві токени
   - Швидша генерація
   - Менша ймовірність "галюцинацій" AI

3. **Безпечний запас:**
   - Якщо AI генерує більше - не обріже
   - Якщо AI генерує менше - не проблема

---

## Рекомендації

### 1. Додати maxOutputTokens для генерації плану

```typescript
// geminiService.ts - generateWorkoutPlan
const model = ai!.getGenerativeModel({ 
  model: selectedModel,
  generationConfig: {
    maxOutputTokens: 32000, // Достатньо для 6 днів з детальними описами
    temperature: 0.7,
    topK: 40,
    topP: 0.95
  }
});
```

### 2. Додати логування розміру відповіді

```typescript
console.log('Received response:', {
  responseLength: jsonStr.length,
  estimatedTokens: Math.ceil(jsonStr.length / 4), // Приблизно 1 токен = 4 символи
  percentOfLimit: Math.ceil((jsonStr.length / 4) / 32000 * 100) + '%'
});
```

### 3. Додати попередження, якщо відповідь обрізана

```typescript
if (result.candidates?.[0]?.finishReason === 'MAX_TOKENS') {
  console.warn('Відповідь AI була обрізана через ліміт токенів');
  // Можна спробувати регенерувати з меншою кількістю днів
}
```

### 4. Оптимізувати промпт

**Замість:**
```
"Надай достатньо детальний, але без зайвої води (приблизно 5-7 речень) покроковий опис..."
```

**Краще:**
```
"Надай детальний опис техніки (4-6 речень): початкова позиція, рух, дихання, типові помилки."
```

**Економія:** ~20% токенів без втрати якості

---

## Висновок

### Поточний стан
- Відсутній `maxOutputTokens`, тому існує ризик обрізання
- Типовий ліміт може становити 2048-8192 токенів
- План на шість днів може не згенеруватися повністю

### Після виправлення
- Значення `maxOutputTokens: 32000` гарантує повну відповідь
- Додано логування розміру відповіді
- Виводиться попередження про обрізання
- Промпт оптимізовано

### Ризики
- Низький ризик обрізання після виправлення
- План на шість днів з детальними описами споживає приблизно 30 000 токенів (94% від заданого ліміту)
- Є запас у 2 000 токенів для непередбачуваних випадків
