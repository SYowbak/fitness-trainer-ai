# Система фонового аналізу тренувань

## Огляд

Нова система фонового аналізу тренувань забезпечує розумний AI-аналіз після завершення тренування та генерує персоналізовані рекомендації для наступного тренування цього дня.

## Ключові особливості

### Що було виправлено

1. **Синхронний аналіз → Фоновий аналіз**
   - Раніше: Аналіз блокував UI при завершенні тренування
   - Тепер: Аналіз відбувається у фоні, не блокуючи користувача

2. **Втрачені рекомендації → Збережені рекомендації**
   - Раніше: Рекомендації зникали при перезавантаженні
   - Тепер: Рекомендації зберігаються в БД та завантажуються при наступному тренуванні

3. **Базові рекомендації → Розумні AI рекомендації**
   - Раніше: Тільки загальні поради "Продовжуйте тренуватися"
   - Тепер: Персоналізовані рекомендації на основі аналізу виконання

4. **Ігнорування пропущених вправ → Рекомендації для всіх вправ**
   - Раніше: Пропущені вправи не аналізувались
   - Тепер: Система дає поради чому варто робити пропущені вправи

5. **Відсутність офлайн підтримки → Повна офлайн підтримка**
   - Раніше: Аналіз не працював офлайн
   - Тепер: Аналіз відкладається та виконується при відновленні мережі

## Архітектура системи

### Основні компоненти:

1. **BackgroundWorkoutAnalysisService** (`services/backgroundWorkoutAnalysis.ts`)
   - Singleton сервіс для управління чергою аналізу
   - Розумна генерація промптів для AI
   - Обробка офлайн/онлайн режимів

2. **Оновлений geminiService** (`services/geminiService.ts`)
   - Підтримка кастомних промптів для аналізу
   - Парсинг AI відповідей в структуровані рекомендації

3. **Розширені типи** (`types.ts`)
   - Нові поля в `WorkoutLog` для статусу аналізу
   - `nextWorkoutRecommendations` для збереження рекомендацій

### Потік роботи:

```
1. Користувач завершує тренування
   ↓
2. handleEndWorkout() зберігає лог та запускає фоновий аналіз
   ↓
3. BackgroundWorkoutAnalysisService додає в чергу
   ↓
4. AI аналізує виконання та генерує рекомендації
   ↓
5. Рекомендації зберігаються в БД
   ↓
6. При наступному тренуванні рекомендації завантажуються
```

## Система пріоритетів рекомендацій

### Пріоритет 1: AI рекомендації з аналізу
- Позначаються як рекомендації AI та відображаються синім кольором
- Містять конкретні поради про вагу, повторення, техніку
- Базуються на аналізі попереднього виконання

### Пріоритет 2: Базові рекомендації
- Показуються тільки якщо немає AI рекомендацій
- Загальні поради про прогрес та техніку
- Позначаються зеленим кольором

### Пріоритет 3: Рекомендації самопочуття
- Інтегруються з AI рекомендаціями
- Враховуються при генерації адаптивного плану

## Статуси аналізу

- **pending** - Очікує аналізу
- **analyzing** - Аналіз в процесі
- **completed** - Аналіз завершено успішно
- **failed** - Аналіз не вдався (буде повторено при відновленні мережі)

## Приклади рекомендацій

### Для виконаних вправ:
```
Рекомендація на основі аналізу
"Ви успішно виконали присідання з 80кг. Спробуйте збільшити вагу до 82.5кг в наступному тренуванні."
Причина: Всі підходи виконані з хорошою технікою
Рекомендована вага: 82.5 кг
```

### Для пропущених вправ:
```
Рекомендація для прогресу
"Вправу було пропущено в минулому тренуванні. Рекомендуємо виконати її в наступний раз для повноцінного розвитку."
Причина: Вправа була пропущена
```

## Офлайн підтримка

1. **Завершення тренування офлайн:**
   - Лог зберігається локально з `analysisStatus: 'pending'`
   - Додається в офлайн чергу синхронізації

2. **Відновлення мережі:**
   - Автоматично запускається `retryFailedAnalyses()`
   - Всі pending/failed аналізи повторюються
   - Рекомендації генеруються та зберігаються

## API методи

### BackgroundWorkoutAnalysisService

```typescript
// Додати тренування в чергу аналізу
queueWorkoutForAnalysis(
  workoutLog: WorkoutLog,
  userProfile: UserProfile,
  dayPlan: DailyWorkoutPlan,
  previousLogs: WorkoutLog[],
  saveWorkoutLog: (log: WorkoutLog) => Promise<WorkoutLog>
): Promise<void>

// Отримати рекомендації для дня
getRecommendationsForDay(
  workoutLogs: WorkoutLog[], 
  dayNumber: number
): ExerciseRecommendation[]

// Повторити невдалі аналізи
retryFailedAnalyses(
  workoutLogs: WorkoutLog[],
  userProfile: UserProfile,
  workoutPlan: DailyWorkoutPlan[],
  saveWorkoutLog: (log: WorkoutLog) => Promise<WorkoutLog>
): Promise<void>
```

## Інтеграція з існуючою системою

### App.tsx зміни:
- `handleEndWorkout()` - запускає фоновий аналіз
- `handleStartWorkoutWithWellnessCheck()` - завантажує рекомендації
- Офлайн синхронізація - повторює невдалі аналізи

### ExerciseCard.tsx зміни:
- Система пріоритетів рекомендацій
- Розрізнення AI vs базових рекомендацій
- Покращений UI для відображення

## Тестування

### Сценарій 1: Онлайн аналіз
1. Завершіть тренування онлайн
2. Перевірте логи: "Запускаємо фоновий аналіз"
3. Дочекайтесь повідомлення: "Аналіз завершено успішно"
4. Почніть наступне тренування цього дня
5. Переконайтесь, що рекомендації завантажилися

### Сценарій 2: Офлайн аналіз
1. Завершіть тренування офлайн
2. Переконайтесь, що лог має `analysisStatus: 'pending'`
3. Відновіть мережу
4. Перевірте логи: "Повторюємо невдалі аналізи"
5. Дочекайтесь завершення аналізу

## Переваги нової системи

- Не блокує UI — користувач може одразу продовжувати роботу
- Персоналізовані рекомендації — AI аналізує конкретне виконання
- Офлайн підтримка — працює без інтернету
- Збереження рекомендацій — інформація не втрачається при перезавантаженні
- Розумні поради — враховує пропущені вправи та прогрес
- Система пріоритетів — показує найважливіші рекомендації
- Інтеграція з блоком здоров'я — враховує проблеми користувача в аналізі

## Майбутні покращення

- Аналіз тенденцій прогресу за кілька тренувань
- Автоматичні корекції плану на основі аналізу
- Рекомендації щодо відпочинку та відновлення
- Інтеграція з носимими пристроями для аналізу пульсу
