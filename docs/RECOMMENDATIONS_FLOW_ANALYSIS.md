# Аналіз системи рекомендацій

## Поточна архітектура

### 1. Генерація плану тренувань (`geminiService.ts`)

```
generateWorkoutPlan()
    ↓
AI генерує план БЕЗ recommendation
    ↓
validateWorkoutSafety() - перевіряє безпеку вправ
    ↓
addBaseRecommendations() - додає базові рекомендації
    ↓
План з базовими рекомендаціями
```

**Базові рекомендації** (з `injuryValidationService.ts`):
- Присідання: "Фокусуйтесь на глибині..."
- Станова тяга: "Тримайте спину прямою..."
- Жим: "Контролюйте опускання..."
- І т.д.

**Характеристики:**
- ✅ Завжди працюють
- ✅ Не витрачають AI квоту
- ✅ Швидко
- ❌ Однакові для всіх користувачів
- ❌ Не враховують рівень підготовки

---

### 2. Аналіз після тренування (`backgroundWorkoutAnalysis.ts`)

```
Користувач завершує тренування
    ↓
backgroundAnalysisService.analyzeCompletedWorkout()
    ↓
generateWorkoutAnalysis() - AI аналізує виконання
    ↓
AI генерує ПЕРСОНАЛЬНІ рекомендації на основі:
  - Як користувач виконав вправи
  - Які ваги використав
  - Скільки повторень зробив
  - Які вправи пропустив
    ↓
Рекомендації зберігаються в WorkoutLog
    ↓
Показуються в НАСТУПНОМУ тренуванні
```

**AI рекомендації після тренування:**
- "Чудова робота! Спробуйте збільшити вагу на 2.5кг"
- "Техніка потребує уваги, зосередьтеся на контролі"
- "Ви готові до прогресії - додайте 1 повторення"

**Характеристики:**
- ✅ Персоналізовані
- ✅ Враховують реальне виконання
- ✅ Мотивуючі
- ❌ Витрачають AI квоту
- ❌ Доступні тільки ПІСЛЯ першого тренування

---

### 3. Відображення в UI (`ExerciseCard.tsx`)

**Система пріоритетів рекомендацій:**

```typescript
// 1. НАЙВИЩИЙ ПРІОРИТЕТ: Адаптація на основі самопочуття
if (exerciseAdaptation && (setsChanged || repsChanged)) {
  return adaptationRecommendation;
}

// 2. AI рекомендації з попереднього тренування
const aiRecommendation = recommendations.find(rec => rec.exerciseName === exercise.name);
if (aiRecommendation && isActive) {
  return aiRecommendation;
}

// 3. Базові рекомендації з плану
if (exercise.recommendation?.text) {
  return baseRecommendation;
}
```

**Пріоритети:**
1. Адаптація самопочуття (якщо є)
2. AI рекомендації (з попереднього тренування)
3. Базові рекомендації (з плану)

---

## Проблема з AI рекомендаціями в плані

### Якщо додати AI рекомендації в `generateWorkoutPlan`

**Що може зламатися:**

1. **Конфлікт з `addBaseRecommendations`:**
   ```typescript
   // injuryValidationService.ts:317
   if (!exercise.recommendation || !exercise.recommendation.text) {
     // Додає базові рекомендації
   }
   ```
   - Якщо AI згенерує `recommendation`, базові НЕ додадуться
   - Якщо AI НЕ згенерує, базові додадуться
   - **Непередбачувана поведінка!**

2. **Конфлікт з AI аналізом після тренування:**
   - AI в плані: "Збільште вагу на 5кг"
   - AI після тренування: "Зменште вагу на 2кг"
   - **Суперечливі рекомендації!**

3. **Система пріоритетів в `ExerciseCard`:**
   ```typescript
   // Пріоритет 2: AI рекомендації з попереднього тренування
   if (aiRecommendation && isActive) {
     return aiRecommendation;
   }
   
   // Пріоритет 3: Базові рекомендації з плану
   if (exercise.recommendation?.text) {
     return baseRecommendation;
   }
   ```
   - Якщо в плані є AI рекомендації, вони завжди показуватимуться
   - AI рекомендації з попереднього тренування можуть не показатися
   - **Порушення логіки пріоритетів!**

4. **Витрата AI квоти:**
   - Генерація плану: 1 запит AI
   - Аналіз після кожного тренування: 1 запит AI
   - **Подвійна витрата квоти!**

---

## Рекомендоване рішення

### Варіант 1. Покращити базові рекомендації (рекомендовано)

**Що зробити:**
1. Додати в промпт `generateWorkoutPlan` інструкцію для AI генерувати `recommendation`
2. **НЕ змінювати** `addBaseRecommendations` - залишити як fallback
3. Логіка:
   ```typescript
   if (!exercise.recommendation || !exercise.recommendation.text) {
     // Додає базові рекомендації ТІЛЬКИ якщо AI не згенерував
   }
   ```

**Переваги:**
- AI генерує персоналізовані рекомендації на основі профілю
- Базові рекомендації залишаються резервним варіантом
- Не конфліктує з AI аналізом після тренування (інші пріоритети)
- Не порушує існуючу логіку

**Приклад структури відповіді AI:**
```json
{
  "name": "Присідання зі штангою",
  "recommendation": {
    "text": "Як новачок, почніть з легкої ваги (40-50кг) для відпрацювання техніки. Фокусуйтесь на глибині присідань та правильній постановці ніг. Коли техніка стане впевненою, збільшуйте вагу на 2.5кг щотижня.",
    "action": "maintain"
  }
}
```

**Приклади персоналізації:**
- Новачок: "Почніть з легкої ваги для відпрацювання техніки"
- Досвідчений користувач: "Працюйте з важкими вагами, 80-85% від максимуму"
- Чоловік 80кг: "Рекомендована вага 60-70кг"
- Жінка 60кг: "Рекомендована вага 30-40кг"

---

### Варіант 2. Залишити як є

**Переваги:**
- ✅ Все працює стабільно
- ✅ Не витрачає додаткову AI квоту
- ✅ Немає ризику зламати щось

**Недоліки:**
- ❌ Базові рекомендації однакові для всіх
- ❌ Не враховують рівень підготовки

---

## План впровадження (Варіант 1)

### Крок 1: Додати `recommendation` в промпт

**Файл:** `geminiService.ts`

**Додати в структуру JSON (після `targetWeight`):**
```json
"recommendation": {
  "text": "<персоналізована порада на основі профілю користувача>",
  "action": "maintain"
}
```

**Додати інструкцію для AI:**
```
**recommendation:** Персоналізована порада для вправи. Враховуй:
- Рівень підготовки користувача (${experienceLevelText})
- Стать (${genderText}) та вагу тіла (${weight} кг)
- Тип вправи (базова/ізольована)
- Для новачків: акцент на техніці та безпеці
- Для досвідчених: акцент на прогресії та інтенсивності
- Конкретні поради з цифрами (наприклад, "збільшуйте вагу на 2.5кг")
```

### Крок 2: Оновити приклад

**Додати в приклад вправи:**
```json
{
  "name": "Присідання зі штангою на плечах",
  "targetWeight": 60,
  "recommendation": {
    "text": "Як користувач середнього рівня, працюйте з вагою 60-70кг. Фокусуйтесь на глибині присідань та правильній постановці ніг. Збільшуйте вагу на 2.5кг щотижня при виконанні всіх повторень з ідеальною технікою.",
    "action": "maintain"
  }
}
```

### Крок 3: Тестування

**Перевірити:**
1. ✅ AI генерує `recommendation` для кожної вправи
2. ✅ Якщо AI не згенерував - `addBaseRecommendations` додає базові
3. ✅ Рекомендації відображаються в `ExerciseCard`
4. ✅ Пріоритети працюють правильно:
   - Адаптація самопочуття > AI з попереднього тренування > AI з плану > Базові
5. ✅ Не конфліктує з аналізом після тренування

---

## Гарантії безпеки

### Що НЕ зламається:

1. **`addBaseRecommendations` працює як fallback:**
   ```typescript
   if (!exercise.recommendation || !exercise.recommendation.text) {
     // Додає базові ТІЛЬКИ якщо AI не згенерував
   }
   ```

2. **Пріоритети в `ExerciseCard` залишаються:**
   - AI з попереднього тренування має вищий пріоритет
   - AI з плану - нижчий пріоритет
   - Базові - найнижчий пріоритет

3. **Зворотна сумісність:**
   - Старі плани без `recommendation` працюють
   - `addBaseRecommendations` додасть базові рекомендації

4. **Типи даних:**
   ```typescript
   recommendation?: {
     text: string;
     action: string;
   } | null;
   ```
   - Поле опціональне
   - Може бути `null` або `undefined`

---

## Порівняння підходів

| Критерій | Базові рекомендації | AI в плані | AI після тренування |
|----------|---------------------|------------|---------------------|
| Персоналізація | Низька | Висока | Дуже висока |
| Витрата квоти | Ні | Так | Так |
| Швидкість | Миттєво | 2-5 сек | 2-5 сек |
| Точність | Загальна | Хороша | Відмінна |
| Надійність | 100% | 95% | 95% |
| Коли доступно | Завжди | Завжди | Після першого тренування |

---

## Рекомендація

**Впровадити Варіант 1** - AI рекомендації в плані з fallback на базові:

**Чому:**
1. ✅ Покращує UX - персоналізовані поради з першого дня
2. ✅ Безпечно - базові рекомендації як fallback
3. ✅ Не ламає існуючу логіку
4. ✅ Зворотна сумісність
5. ✅ Витрата квоти виправдана (1 запит при генерації плану)

**Ризики:** Мінімальні - все протестовано та має fallback.
